---
keywords: fastai
description: I'll describe how to build a custom docker image containing an anaconda environment which can be run on Paperspace.
title: How to build a Docker image with an Anaconda environment in Paperspace?
toc: true 
badges: false
comments: true
categories: [docker, tools]
nb_path: _notebooks/2022-06-15-anaconda-in-docker-on-paperspace.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-06-15-anaconda-in-docker-on-paperspace.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://www.paperspace.com/">Paperspace</a> is an affordable tool for obtaining cloud compute power. Using it, you can run jupyter notebooks, python scripts, or just about anything, provided you can write the right Docker file. Plus some of the compute instances also come with GPUs, making Paperspace an alternative to <a href="https://colab.research.google.com/">Google Colab</a>. In contrast with Google Colab though, Paperspace saves the files you use, so they are there when you return. Inspired by Alex's post on <a href="https://mlops.systems/tools/docker/computervision/2022/03/25/paperspace-docker-icevision.html">Building my own image to use IceVision with Paperspace</a>, in this post I'll describe how you can build a docker image to wrap an Anaconda environment, and then run it on Paperspace. The Dockerfile and Anaconda environment I used are available on Github <a href="https://github.com/krishanr/paperspaceconda">here</a>.</p>
<p>The context for this post is that even though a custom anaconda environment can be created and run in the Paperspace images that are readily available, for longer projects, it would be useful to use a Paperspace image that comes prebuilt with a desired environment.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can do this by adding a few additional lines to the standard Paperspace Docker image. Any anconda environment available at 'environment.yml' can be created and activated using these 4 lines:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="k">ADD</span> environment.yml <span class="nv">$APP_HOME</span>/environment.yml
<span class="k">RUN</span> conda env create -f <span class="nv">$APP_HOME</span>/environment.yml

<span class="k">ENV</span> PATH <span class="nv">$CONDA_DIR</span>/envs/tf2/bin:<span class="nv">$PATH</span>
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&quot;source activate tf2&quot;</span> &gt; ~/.bashrc
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first two commands add the conda environment file to the Docker containers workspace, and then create the conda environment.</p>
<p>The third command adds the enviornment directory to the PATH enviroment variable. The directory path contains the environment name, which in this case is tf2 (replace this with your environment name if necessary). Finally, the last command adds a command to activate the enviornment to the bashrc file, so that the environment is activated when the container is started.</p>
<p>That's it! The bulk of the work for creating and running a Docker image with an anaconda environment in Paperspace is done with the above 4 lines of code.</p>
<p>The entire Dockerfile is available on GitHub <a href="https://github.com/krishanr/paperspaceconda/blob/master/Dockerfile">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Following <a href="https://mlops.systems/tools/docker/computervision/2022/03/25/paperspace-docker-icevision.html">Alex</a>, I'll describe the steps to setup a Paperspace instance using this Dockerfile.</p>
<p>First go to your notebooks inside a project, and create a new Paperspace notebook.</p>
<p><img src="/fastpages/images/copied_from_nb/paperspace1.png" alt="text"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, choose a GPU instance to create the notebook (or CPU depending on the project), for example the RTX5000 option, and an automatic shutdown of 6 hours.</p>
<p><img src="/fastpages/images/copied_from_nb/paperspace2.png" alt="text"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next the Dockerfile will have to be built and pushed to Dockerhub, before it can be used with paperspace.</p>
<p>To build the Dockerfile, just run</p>
<div class="highlight"><pre><span></span>docker build -t k2rajara/paperspace:3.0
</pre></div>
<p>for example, in the same directory as the Dockerfile.</p>
<p>In the above code, 'k2rajara/paperspace' is the <a href="https://hub.docker.com/r/k2rajara/paperspace">container name</a> on Dockerhub.  To create your own repository on Dockerhub, follow the instructions <a href="https://docs.docker.com/docker-hub/">here</a>. Then push your image there. Once this is complete, its details can be added to the advanced section:</p>
<p><img src="/fastpages/images/copied_from_nb/paperspace3.png" alt="text"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The command that is run in the container is the default one for Paperspace:</p>
<div class="highlight"><pre><span></span>jupyter lab --allow-root --ip<span class="o">=</span><span class="m">0</span>.0.0.0 --no-browser --ServerApp.trust_xheaders<span class="o">=</span>True --ServerApp.disable_check_xsrf<span class="o">=</span>False --ServerApp.allow_remote_access<span class="o">=</span>True --ServerApp.allow_origin<span class="o">=</span><span class="s1">&#39;*&#39;</span> --ServerApp.allow_credentials<span class="o">=</span>True
</pre></div>
<p>Finally after clicking "Start Notebook", Paperspace should pull the image from Dockerhub and run jupyter lab as requested.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In my case, the conda environment I created is available on Github <a href="https://github.com/krishanr/paperspaceconda/blob/master/environment.yml">here</a> and shown here:</p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tf2</span>
<span class="nt">channels</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">defaults</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">anaconda</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python=3.6</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip=21</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jupyterlab</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jupyter_client=7.1.0</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jupyter_server=1.13.1</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tensorflow-gpu=2.2</span>
<span class="p p-Indicator">-</span> <span class="nt">pip</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mlflow==1.11.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python-dotenv==0.15.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">matplotlib==3.1.2</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Pillow==8.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scikit-image==0.17.2</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ruamel_yaml==0.16.12</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The project I was working on used python 3.6, and tensorflow 2.2. Due to the outated version of python, I also had to install the jupyter client and server manually, to avoid bugs. However, the environment can be customized depending on your project requirements.</p>
<p>For example, to create a minimal installation with tensorflow2 and jupyterlab, use:</p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tf2</span>
<span class="nt">channels</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">anaconda</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jupyterlab</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tensorflow-gpu</span>
</pre></div>

</div>
</div>
</div>
</div>
 

